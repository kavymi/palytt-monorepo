name: Deploy to Railway

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - backend
          - web
          - convex
          - all

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      web: ${{ steps.filter.outputs.web }}
      convex: ${{ steps.filter.outputs.convex }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'palytt-backend/**'
            web:
              - 'palytt-web/**'
            convex:
              - 'palytt-convex/**'

  deploy-backend:
    name: Deploy Backend
    needs: changes
    runs-on: ubuntu-latest
    if: |
      (needs.changes.outputs.backend == 'true') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.service == 'backend' || github.event.inputs.service == 'all'))
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy Backend to Railway
        working-directory: palytt-backend
        run: |
          echo "ðŸš‚ Deploying palytt-backend to Railway..."
          railway link --project palytt --service palytt-backend --environment production
          railway up --detach
          echo "âœ… Backend deployment initiated!"

  deploy-web:
    name: Deploy Web
    needs: changes
    runs-on: ubuntu-latest
    if: |
      (needs.changes.outputs.web == 'true') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.service == 'web' || github.event.inputs.service == 'all'))
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy Web to Railway
        working-directory: palytt-web
        run: |
          echo "ðŸš‚ Deploying palytt-web to Railway..."
          railway link --project palytt --service palytt-web --environment production
          railway up --detach
          echo "âœ… Web deployment initiated!"

  deploy-convex:
    name: Deploy Convex Functions
    needs: changes
    runs-on: ubuntu-latest
    if: |
      (needs.changes.outputs.convex == 'true') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.service == 'convex' || github.event.inputs.service == 'all'))
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: palytt-convex
        run: npm ci

      - name: Deploy Convex Functions
        working-directory: palytt-convex
        env:
          CONVEX_SELF_HOSTED_URL: https://convex-backend-production-9e36.up.railway.app
          CONVEX_SELF_HOSTED_ADMIN_KEY: ${{ secrets.CONVEX_ADMIN_KEY }}
        run: |
          echo "ðŸ”„ Deploying Convex functions..."
          npx convex dev --once
          echo "âœ… Convex functions deployed!"

