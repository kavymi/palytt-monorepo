// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  clerkId       String    @unique
  email         String    @unique
  username      String?   @unique
  name          String?
  bio           String?
  profileImage  String?
  website       String?
  phoneHash     String?   // SHA256 hash of normalized phone number for contacts sync
  followerCount Int       @default(0)
  followingCount Int      @default(0)
  postsCount    Int       @default(0)
  isVerified    Boolean   @default(false)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Content Relations
  posts         Post[]
  comments      Comment[]
  likes         Like[]
  bookmarks     Bookmark[]
  lists         List[]
  commentReactions CommentReaction[]

  // Social Relations
  friendsSent        Friend[]  @relation("FriendSender")
  friendsReceived    Friend[]  @relation("FriendReceiver")
  following          Follow[]  @relation("UserFollows")
  followers          Follow[]  @relation("UserFollowing")

  // Messaging Relations
  messages           Message[]
  chatroomParticipants ChatroomParticipant[]

  // Notification Relations
  notifications      Notification[]
  deviceTokens       DeviceToken[]

  // Gathering Invite Relations
  gatheringInvitesSent     GatheringInvite[] @relation("GatheringInvitesSent")
  gatheringInvitesReceived GatheringInvite[] @relation("GatheringInvitesReceived")

  // Referral Relations
  referralsSent            Referral[]        @relation("ReferralsSent")
  referralsReceived        Referral[]        @relation("ReferralsReceived")
  referralRewards          ReferralReward[]

  // Referral tracking
  referralCode             String?           @unique  // User's own referral code
  referredBy               String?           // ClerkId of user who referred them
  referralRewardsCount     Int               @default(0)  // Total rewards earned from referrals

  // Posting Streak tracking
  currentStreak            Int               @default(0)  // Current consecutive days posting
  longestStreak            Int               @default(0)  // Best streak ever achieved
  lastPostDate             DateTime?         // Date of last post (for streak calculation)
  streakFreezeCount        Int               @default(0)  // Number of streak freezes available

  // Activity tracking for re-engagement notifications
  lastActiveAt             DateTime          @default(now())  // Last time user was active in the app
  reengagementSentAt       DateTime?         // Last time a re-engagement notification was sent

  @@map("users")
}

model Post {
  id            String    @id @default(uuid())
  userId        String
  title         String?
  caption       String
  mediaUrls     String[]
  rating        Float?
  menuItems     String[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Location data
  locationName      String?
  locationAddress   String?
  locationCity      String?
  locationState     String?
  locationCountry   String?
  locationPostalCode String?
  locationLatitude  Float?
  locationLongitude Float?

  // Post stats
  likesCount    Int       @default(0)
  commentsCount Int       @default(0)
  savesCount    Int       @default(0)
  viewsCount    Int       @default(0)
  
  // Visibility
  isPublic      Boolean   @default(true)
  isDeleted     Boolean   @default(false)
  
  // Mentions (@users, @places, #hashtags) stored as JSON
  mentions      Json?     // Array of {type, text, targetId, start, end}

  // Relations
  author        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments      Comment[]
  likes         Like[]
  bookmarks     Bookmark[]
  listPosts     ListPost[]

  @@index([userId])
  @@index([createdAt])
  @@map("posts")
}

model Comment {
  id            String    @id @default(uuid())
  postId        String
  authorId      String
  content       String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  post          Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  author        User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  reactions     CommentReaction[]

  @@index([postId])
  @@index([authorId])
  @@map("comments")
}

model CommentReaction {
  id            String    @id @default(uuid())
  commentId     String
  userId        String
  emoji         String    // "fire", "love", "laugh", "sad", "wow"
  createdAt     DateTime  @default(now())

  // Relations
  comment       Comment   @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId, emoji])  // One reaction type per user per comment
  @@index([commentId])
  @@index([userId])
  @@map("comment_reactions")
}

model Like {
  id            String    @id @default(uuid())
  postId        String
  userId        String
  createdAt     DateTime  @default(now())

  // Relations
  post          Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@map("likes")
}

model Bookmark {
  id            String    @id @default(uuid())
  postId        String
  userId        String
  createdAt     DateTime  @default(now())

  // Relations
  post          Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@map("bookmarks")
}

model List {
  id            String     @id @default(uuid())
  name          String
  description   String?
  userId        String
  isPrivate     Boolean    @default(false)
  coverImageUrl String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  listPosts     ListPost[]

  @@index([userId])
  @@index([createdAt])
  @@map("lists")
}

model ListPost {
  id        String   @id @default(uuid())
  listId    String
  postId    String
  addedAt   DateTime @default(now())

  // Relations
  list      List     @relation(fields: [listId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([listId, postId])
  @@index([listId])
  @@index([postId])
  @@map("list_posts")
}

model Friend {
  id            String       @id @default(uuid())
  senderId      String
  receiverId    String
  status        FriendStatus @default(PENDING)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  sender        User         @relation("FriendSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver      User         @relation("FriendReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
  @@index([senderId])
  @@index([receiverId])
  @@map("friends")
}

model Follow {
  id            String    @id @default(uuid())
  followerId    String
  followingId   String
  createdAt     DateTime  @default(now())

  // Relations
  follower      User      @relation("UserFollows", fields: [followerId], references: [id], onDelete: Cascade)
  following     User      @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

model Message {
  id            String       @id @default(uuid())
  chatroomId    String
  senderId      String
  content       String
  messageType   MessageType  @default(TEXT)
  mediaUrl      String?
  metadata      Json?        // For shared content data, link previews, etc.
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  readAt        DateTime?

  // Relations
  chatroom      Chatroom     @relation(fields: [chatroomId], references: [id], onDelete: Cascade)
  sender        User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([chatroomId])
  @@index([senderId])
  @@map("messages")
}

model Chatroom {
  id            String       @id @default(uuid())
  type          ChatroomType @default(DIRECT)
  name          String?
  description   String?
  imageUrl      String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  lastMessageAt DateTime?

  // Relations
  messages      Message[]
  participants  ChatroomParticipant[]

  @@map("chatrooms")
}

model ChatroomParticipant {
  id            String    @id @default(uuid())
  chatroomId    String
  userId        String
  joinedAt      DateTime  @default(now())
  leftAt        DateTime?
  isAdmin       Boolean   @default(false)
  lastReadAt    DateTime?

  // Relations
  chatroom      Chatroom  @relation(fields: [chatroomId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([chatroomId, userId])
  @@index([chatroomId])
  @@index([userId])
  @@map("chatroom_participants")
}

model Notification {
  id            String           @id @default(uuid())
  userId        String
  type          NotificationType
  title         String
  message       String
  data          Json?            // Additional data for the notification
  read          Boolean          @default(false)
  createdAt     DateTime         @default(now())

  // Relations
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@map("notifications")
}

enum FriendStatus {
  PENDING
  ACCEPTED
  BLOCKED
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  FILE
  POST_SHARE
  PLACE_SHARE
  LINK_SHARE
}

enum ChatroomType {
  DIRECT
  GROUP
}

enum NotificationType {
  POST_LIKE
  COMMENT
  COMMENT_LIKE
  FOLLOW
  FRIEND_REQUEST
  FRIEND_ACCEPTED
  FRIEND_POST
  MESSAGE
  POST_MENTION
  GATHERING_INVITE
  GENERAL
}

// ============================================
// GATHERING INVITES
// ============================================

model GatheringInvite {
  id            String              @id @default(uuid())
  gatheringId   String              // ID of the gathering (stored externally or as string reference)
  inviterId     String              // User who sent the invite
  inviteeId     String              // User being invited
  status        GatheringInviteStatus @default(PENDING)
  createdAt     DateTime            @default(now())
  respondedAt   DateTime?

  // Relations
  inviter       User                @relation("GatheringInvitesSent", fields: [inviterId], references: [id], onDelete: Cascade)
  invitee       User                @relation("GatheringInvitesReceived", fields: [inviteeId], references: [id], onDelete: Cascade)

  @@unique([gatheringId, inviteeId])
  @@index([gatheringId])
  @@index([inviterId])
  @@index([inviteeId])
  @@map("gathering_invites")
}

enum GatheringInviteStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

// ============================================
// REFERRAL SYSTEM
// ============================================

model Referral {
  id            String         @id @default(uuid())
  code          String         @unique  // Unique referral code
  referrerId    String         // User who created the referral code
  refereeId     String?        // User who signed up using the code (null until used)
  status        ReferralStatus @default(PENDING)
  rewardType    String?        // Type of reward earned (e.g., "premium_week", "badge")
  rewardAmount  Int?           // Numeric value if applicable
  createdAt     DateTime       @default(now())
  completedAt   DateTime?      // When the referral was completed (referee signed up)

  // Relations
  referrer      User           @relation("ReferralsSent", fields: [referrerId], references: [id], onDelete: Cascade)
  referee       User?          @relation("ReferralsReceived", fields: [refereeId], references: [id], onDelete: SetNull)

  @@index([referrerId])
  @@index([refereeId])
  @@index([code])
  @@map("referrals")
}

enum ReferralStatus {
  PENDING     // Code created but not used
  USED        // Code used, referee signed up
  REWARDED    // Reward has been given to referrer
  EXPIRED     // Code expired (optional time limit)
}

// ============================================
// REFERRAL REWARDS
// ============================================

model ReferralReward {
  id            String      @id @default(uuid())
  userId        String
  type          RewardType
  amount        Int         @default(1)
  milestone     Int         // Referral count that triggered this reward
  claimedAt     DateTime?   // When the reward was claimed/used
  expiresAt     DateTime?   // Optional expiration date
  createdAt     DateTime    @default(now())

  // Relations
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@map("referral_rewards")
}

enum RewardType {
  STREAK_FREEZE   // Adds streak freeze to user
  PREMIUM_WEEK    // Premium features for a week
  PREMIUM_MONTH   // Premium features for a month
  BADGE           // Unlocks a special badge
  VIP_STATUS      // VIP Ambassador status
}

// ============================================
// DEVICE TOKENS (for Push Notifications)
// ============================================

model DeviceToken {
  id            String       @id @default(uuid())
  userId        String
  token         String       @unique  // APNs device token
  platform      Platform     @default(IOS)
  isActive      Boolean      @default(true)
  lastUsedAt    DateTime     @default(now())
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([isActive])
  @@map("device_tokens")
}

enum Platform {
  IOS
  ANDROID
  WEB
} 